---
import Layout from '../layouts/layout.astro';
---

<Layout title="My Dashboard | blogbyJosh">
  <div class="max-w-4xl mx-auto pt-24 px-4 pb-20">
    
    <div id="loading-screen" class="text-center pt-20">
      <p class="text-zinc-500 font-mono text-xs uppercase tracking-widest animate-pulse">Loading Account Data...</p>
    </div>

    <div id="dashboard-content" class="hidden">
      
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-16 border-b border-zinc-900 pb-8 gap-6">
        <div>
          <h1 class="text-4xl font-black text-white uppercase tracking-tighter mb-2">My Account</h1>
          <p class="text-zinc-500 font-mono text-xs uppercase tracking-widest">
            Logged in as: <span id="user-email" class="text-white">...</span>
          </p>
        </div>
        
        <div class="flex gap-4">
          <a href="/create" class="bg-white text-black px-6 py-3 text-xs font-bold uppercase tracking-widest hover:bg-zinc-200 transition-colors">
            New Drop
          </a>
          <button id="sign-out-btn" class="border border-zinc-800 text-zinc-400 px-6 py-3 text-xs font-bold uppercase tracking-widest hover:border-red-900 hover:text-red-500 transition-colors">
            Sign Out
          </button>
        </div>
      </div>

      <div class="mb-20 bg-zinc-900/20 p-8 border border-zinc-800 rounded-lg">
        <h2 class="text-xl font-bold text-white uppercase tracking-widest mb-6">Security Settings</h2>
        <form id="update-password-form" class="flex flex-col md:flex-row gap-4 items-end">
          <div class="w-full">
            <label class="block text-xs font-bold text-zinc-500 uppercase tracking-widest mb-2">New Password</label>
            <input type="password" name="password" placeholder="••••••••" class="w-full bg-black border border-zinc-800 p-3 text-white focus:border-white outline-none" required />
          </div>
          <button type="submit" class="bg-zinc-800 text-white px-6 py-3.5 text-xs font-bold uppercase tracking-widest hover:bg-zinc-700 whitespace-nowrap w-full md:w-auto">
            Update Password
          </button>
        </form>
      </div>

      <div>
        <h2 class="text-xl font-bold text-white uppercase tracking-widest mb-8">My Drop History</h2>
        <div id="posts-container" class="grid gap-4">
          </div>
      </div>

    </div>

  </div>
</Layout>

<script>
  import { supabase } from "../lib/supabase";

  const loadingScreen = document.getElementById('loading-screen');
  const dashboardContent = document.getElementById('dashboard-content');
  const userEmailEl = document.getElementById('user-email');
  const postsContainer = document.getElementById('posts-container');

  async function initDashboard() {
    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      window.location.href = '/login';
      return;
    }

    if(userEmailEl) userEmailEl.innerText = session.user.email || "User";
    loadingScreen?.classList.add('hidden');
    dashboardContent?.classList.remove('hidden');

    const { data: myPosts, error } = await supabase
      .from('posts')
      .select('*')
      .eq('user_id', session.user.id) // Only get MY posts
      .order('created_at', { ascending: false });

    if (postsContainer) {
      if (!myPosts || myPosts.length === 0) {
        postsContainer.innerHTML = `
          <div class="text-center py-12 border border-zinc-900 border-dashed">
            <p class="text-zinc-600 font-mono text-sm uppercase mb-4">You haven't posted any drops yet.</p>
            <a href="/create" class="text-white underline text-xs font-bold uppercase tracking-widest">Start Writing</a>
          </div>
        `;
      } else {
        postsContainer.innerHTML = myPosts.map(post => `
          <div class="group flex flex-col md:flex-row items-start md:items-center justify-between bg-black border border-zinc-900 p-6 hover:border-zinc-700 transition-colors">
            <div class="mb-4 md:mb-0">
              <a href="/post/${post.id}" class="text-lg font-bold text-zinc-300 group-hover:text-white uppercase tracking-tight block">
                ${post.title}
              </a>
              <span class="text-[10px] text-zinc-600 font-mono uppercase">
                Published: ${new Date(post.created_at).toLocaleDateString()}
              </span>
            </div>
            <div class="flex gap-3">
              <a href="/edit/${post.id}" class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest hover:text-white border border-zinc-800 px-3 py-2 hover:border-zinc-600">
                Edit
              </a>
              <a href="/post/${post.id}" class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest hover:text-white border border-zinc-800 px-3 py-2 hover:border-zinc-600">
                View
              </a>
            </div>
          </div>
        `).join('');
      }
    }
  }

  initDashboard();

  const signOutBtn = document.getElementById('sign-out-btn');
  if (signOutBtn) {
    signOutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = "/";
    });
  }

  const passwordForm = document.getElementById('update-password-form') as HTMLFormElement;
  if (passwordForm) {
    passwordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(passwordForm);
      const newPassword = formData.get('password') as string;
      const btn = passwordForm.querySelector('button');

      if(btn) { btn.textContent = "UPDATING..."; btn.disabled = true; }

      const { error } = await supabase.auth.updateUser({ password: newPassword });

      if (error) {
        alert("Error: " + error.message);
      } else {
        alert("Password updated successfully!");
        passwordForm.reset();
      }

      if(btn) { btn.textContent = "UPDATE PASSWORD"; btn.disabled = false; }
    });
  }
</script>